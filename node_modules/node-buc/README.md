# node-buc [![status](http://toast.corp.taobao.com/task/state/id/4423)](http://toast.corp.taobao.com/task/view/id/4423)

[![build status](http://gitlab-ci.alibaba-inc.com/projects/93/status.png?ref=master)](http://gitlab-ci.alibaba-inc.com/projects/93?ref=master)

![logo](http://gitlab.alibaba-inc.com/node/node-buc/raw/master/logo.png)

基于buc的阿里巴巴单点登录模块.

* BUC 技术支持 @冰梨 , @嘉措
* BUC SSO 全部文档: http://gitlab.alibaba-inc.com/libin.lb/buc/tree/master
* BUC SSO 权限申请: http://docs.alibaba-inc.com/pages/viewpage.action?pageId=79072804
* BUC SSO 登录协议: http://gitlab.alibaba-inc.com/libin.lb/buc/blob/master/sso-client-protocal.md
* RESTful API document: http://docs.alibaba-inc.com/pages/viewpage.action?pageId=119972155

## Buc SSO Server URL

* Test: https://login-test.alibaba-inc.com
* Online: https://login.alibaba-inc.com

## BUC API Hosts

* 开发测试环境: [buc-uc-test.alibaba-inc.com](https://buc-uc-test.alibaba-inc.com/rpc/enhancedUserQuery/findUsers/byGeneralCriteria.json?nickNameCn=%E8%8B%8F%E5%8D%83)
* 生产机房内部调度: [buc-inside.alibaba-inc.com](https://buc-inside.alibaba-inc.com/rpc/enhancedUserQuery/findUsers/byGeneralCriteria.json?nickNameCn=%E8%8B%8F%E5%8D%83)
* 外部调用: [buc.alibaba-inc.com](https://buc.alibaba-inc.com/rpc/enhancedUserQuery/findUsers/byGeneralCriteria.json?nickNameCn=%E8%8B%8F%E5%8D%83)

关于开发测试环境:

> @冰梨: 有些敏感数据也都屏蔽了，有些数据没有及时同步到也可能的

问题: 就是我用测试环境数据来判断员工是否存在, 是ok的?

> @冰梨: 最多有一些新员工的数据会同步慢一点

发现数据没有同步, 怎么办?

> @冰梨: 让他去 https://login-test.alibaba-inc.com/ 登录一次, 然后系统就会做同步了,
> 第一次会提示用户不存在，第二次应该就可以了

## Install

```bash
$ npm install tnpm -g
$ tnpm install node-buc
```

## 使用举例

```js
var buc = require('node-buc');
var connect = require('connect');

// 依赖 `connect.session()`
var app = connect(
  connect.cookieParser(),
  connect.session({
    secret: 'secret here'
  })
);

// 请求 /admin 路径的都需要用户授权
// 路径规则 可以使String类型 '/admin',可以是正则 /^\/admin/.
app.use(buc(/^\/admin/, {
  server: 'https://login-test.alibaba-inc.com',
  account: 'test',
  // 如果你的应用支持 access token 登录, 那么请设置这个参数, 如 阿里内网内嵌应用
  authOptions: {
    // appcode: 'xxxxxxxxxxx',
    // tokenField: 'accessToken',
    // type: 'api',
  },
}));

app.use('/admin', function (req, res, next) {
  // 登录后，直接可以在session取到改用户的信息
  res.end(JSON.stringify(req.session.user));
});
```

## 强制不使用证书登录

```js
app.use(buc(/^\/admin/, {
  server: 'https://login-test.alibaba-inc.com',
  account: 'test',
  loginParams: {
    CANCEL_CERT: true,
  }
}));
```

## User Auth API

```js
/**
 * Create buc user auth middleware.
 * BUC doc: http://docs.alibaba-inc.com/display/RC/Buc+SSO+USER+GUIDE
 *
 * @param {Regex|Function(pathname, req)} match, detect which url need to check user auth.
 * @param {Object} options
 *  - {String} account, buc appname, must provide.
 *  - {String} [server], buc server root url, default is 'https://login-test.alibaba-inc.com'.
 *      You must change it to 'https://login.alibaba-inc.com' on production env.
 *
 *  @see http://docs.alibaba-inc.com/pages/viewpage.action?pageId=107288804
 *  - {Object} [authOptions] 如果你的应用支持 access token 登录, 那么请设置这个参数, 如 阿里内网内嵌应用
 *    - {String} appcode buc分配的 appcode, 如有疑问, 请联系@冰梨
 *    - {String} [tokenField] access token 在 querystring 中的字段名, 默认是 accessToken
 *    - {String} [type] app type, 默认是 app, 可选是 api
 *
 *  - {Number} [timeout], buc rpc communicate request timeout, default is `urllib.TIMEOUT`: 5 seconds.
 *  - {String} [userField], req.session[userField] name, default is 'user'.
 *  - {String} [loginPath], default is '/login'.
 *  - {String} [logoutPath], default is '/logout'.
 *  - {String} [contextPath], custom app url root path, default is '/'.
 *  - {Object} [loginParams], default is empty.
 *   - {String} CANCEL_CERT, if you don't want to use cert login, please set `CANCEL_CERT='true'`.
 *  - {Function(req, user, callback)} [loginCallback], you can handle user login logic here.
 *    - {Function(err, user, redirectURL)} callback
 *  - {Function(req, user, callback)} [logoutCallback], you can handle user logout logic here.
 *    - {Function(err, redirectURL)} callback
 * @return {Function(req, res, next)} middleware
 */
function bucMiddleware(match, options);
```

### Demo: [hello world](http://gitlab.alibaba-inc.com/node/node-buc/blob/master/example/helloworld.js)

绑定hosts

```
# /etc/hosts
127.0.0.1 dev.tcif.taobao.com
```

运行 `helloworld.js`

```bash
$ node example/helloworld.js
```

## User Search API

Use `buc.api` to search user infos.

```js
var buc = require('node-buc');

buc.api.API_HOST = 'buc.alibaba-inc.com';

buc.api.get('苏千', function (err, user) {
  console.log(user);
});
buc.api.get('苏千', {available: 'T'}, function (err, user) {
  console.log(user);
});
buc.api.get('袁锋', {available: 'T', realname: true}, function (err, user) {
  console.log(user);
});
```

```js
/**
 * Search buc users.
 *
 * @param {String|Object} query, query keyword or query options.
 *   If query is options, must contains:
 *   - {String} q, query keyword
 *   - {String} [available=''], 是否在职  可选  留空则不限，T：在职 ； F：离职
 *   - {Number} [page=1], 页数  1~  可选  留空默认第一页
 *   - [Number] [sizePerPage=20], 每页行数   可选  默认20
 *   - {Boolean} [rightFuzzy] 右模糊查询  可选  留空则默认为true
 *   - {Boolean} [leftFuzzy] 左模糊查询  可选  留空则默认为false
 * @param {Function(err, result)} callback
 *  - {Object} result
 *   - {Number} count, total match users count.
 *   - {Array[Object]} users, match users
 */
exports.search = function (query, callback);

/**
 * Get buc user.
 *
 * @param {String} nick, 邮件前缀或者花名, 如 "suqian.yf" or "苏千"
 * @param {Object} [options=null], 查询参数
 *  - {String} [available=''], 是否在职  可选  留空则不限，T：在职 ； F：离职
 *  - {Boolean} [realname=false], 按真名查询，默认是按花名查询的
 *  - {Boolean} [returnAll=false], 是否只返回第一个结果，
 *    通常按照真名查询的时候，都需要配合使用，设置为 returnAll=true.
 *    一旦设置了 returnAll=true ，那么将返回一个Array数组结果.
 * @param {Function(err, user)} callback
 */
exports.get = function (nick, options, callback);

/**
 * 根据一堆工号查询用户信息
 *
 * @param {Array} ids 工号列表
 * @param {Function(err, users)} callback
 */
exports.findUsersByIds = function (ids, callback);
```

## Authors

```bash
$ git summary

 project  : node-buc
 repo age : 1 year, 9 months
 active   : 42 days
 commits  : 121
 files    : 18
 authors  :
    96	苏千                  79.3%
    18	tangyao                 14.9%
     7	汤尧                  5.8%
```
