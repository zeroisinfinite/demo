/*
 * @name: index.js
 * @description: 
 * @author: wondger@gmail.com
 * @date: 2013-04-26
 * @param: 
 * @todo: 
 * @changelog: 
 */
var https = require("https"),
    express = require("express"),
    nobuc = require("../");

var app = express();

app.configure(function(){
    app.use(express.logger("dev"));
    app.use(express.bodyParser());
    // must set 'secret' for session
    app.use(express.cookieParser());
    app.use(express.session({secret: "keyboard cat"}));
    app.use(express.methodOverride());
    // use to test filter param
    app.use(function(req, res, next) {
        req.session.user = {name: "buc_user"};
        next();
    });
    app.use(nobuc(/.*/,{
        env: app.get("env"),
        appname: "eureka",
        filter: function(req) {
            if (req.session.user) {
                return true;
            }
        }
    }));
});

app.get("/", function(req, res){
    res.json(req._buc_user);
});

app.get("/admin", function(req, res){
    res.json(req.session.user || req.buc_user);
});

app.listen(80);
console.log("fetest on port %d in %s mode", 80, app.get("env"));
